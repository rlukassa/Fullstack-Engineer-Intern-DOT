<div class="page-header">
    <h1><i class="fas fa-calendar-alt"></i> Jadwal Kereta</h1>
    <p>Kelola jadwal dan rute kereta</p>
</div>

{{#if (eq userRole "ADMIN")}}
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <h3 class="card-title"><i class="fas fa-plus-circle"></i> Tambah Jadwal Baru</h3>
    </div>
    <form action="/schedules" method="POST">
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
            <div class="form-group" style="margin: 0;">
                <label class="form-label">Kereta</label>
                <select name="trainId" class="search-input" required>
                    <option value="">Pilih Kereta</option>
                    {{#each trains}}
                    <option value="{{this.id}}">{{this.name}} ({{this.type}})</option>
                    {{/each}}
                </select>
            </div>
            <div class="form-group" style="margin: 0;">
                <label class="form-label">Stasiun Asal</label>
                <select name="originStationId" class="search-input" required>
                    <option value="">Pilih Stasiun Asal</option>
                    {{#each stations}}
                    <option value="{{this.id}}">{{this.code}} - {{this.name}}</option>
                    {{/each}}
                </select>
            </div>
            <div class="form-group" style="margin: 0;">
                <label class="form-label">Stasiun Tujuan</label>
                <select name="destinationStationId" class="search-input" required>
                    <option value="">Pilih Stasiun Tujuan</option>
                    {{#each stations}}
                    <option value="{{this.id}}">{{this.code}} - {{this.name}}</option>
                    {{/each}}
                </select>
            </div>
            <div class="form-group" style="margin: 0;">
                <label class="form-label">Waktu Keberangkatan</label>
                <input type="datetime-local" name="departureTime" class="search-input" required>
            </div>
            <div class="form-group" style="margin: 0;">
                <label class="form-label">Waktu Kedatangan</label>
                <input type="datetime-local" name="arrivalTime" class="search-input" required>
            </div>
            <div class="form-group" style="margin: 0;">
                <label class="form-label">Harga (Rp)</label>
                <input type="number" name="price" class="search-input" placeholder="e.g., 150000" required min="1000">
            </div>
        </div>
        <div style="margin-top: 16px;">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-plus"></i> Tambah Jadwal
            </button>
        </div>
    </form>
</div>
{{/if}}

<!-- Search Box -->
<div class="card" style="margin-bottom: 20px;">
    <form action="/schedules" method="GET">
        <div class="search-box" style="margin: 0;">
            <input type="text" name="search" class="search-input" placeholder="Cari berdasarkan nama kereta, stasiun asal atau tujuan..." value="{{search}}">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-search"></i> Cari
            </button>
            {{#if search}}
            <a href="/schedules" class="btn btn-secondary">
                <i class="fas fa-times"></i> Clear
            </a>
            {{/if}}
        </div>
    </form>
</div>

<div class="card">
    <div class="card-header">
        <h3 class="card-title"><i class="fas fa-list"></i> Semua Jadwal</h3>
        <span class="badge badge-info">{{schedules.length}} jadwal</span>
    </div>
    
    {{#if schedules.length}}
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Kereta</th>
                    <th>Rute</th>
                    <th>Keberangkatan</th>
                    <th>Kedatangan</th>
                    <th>Harga</th>
                    <th>Status</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
                {{#each schedules}}
                <tr>
                    <td style="color: var(--text-muted);">{{this.id}}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 34px; height: 34px; background: var(--primary-light); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-train" style="color: var(--primary); font-size: 0.75rem;"></i>
                            </div>
                            <div>
                                <strong style="color: var(--text-primary);">{{this.train.name}}</strong>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">{{this.train.type}}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="badge badge-info">{{this.originStation.code}}</span>
                            <i class="fas fa-arrow-right" style="color: var(--text-muted); font-size: 0.7rem;"></i>
                            <span class="badge badge-success">{{this.destinationStation.code}}</span>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                            {{this.originStation.name}} â†’ {{this.destinationStation.name}}
                        </div>
                    </td>
                    <td style="color: var(--text-secondary); font-size: 0.8125rem;">{{formatDate this.departureTime}}</td>
                    <td style="color: var(--text-secondary); font-size: 0.8125rem;">{{formatDate this.arrivalTime}}</td>
                    <td><strong style="color: var(--success);">{{formatPrice this.price}}</strong></td>
                    <td>
                        {{#if (eq this.journeyStatus "BELUM_BERANGKAT")}}
                        <span class="badge badge-warning"><i class="fas fa-clock"></i> Belum Berangkat</span>
                        {{else if (eq this.journeyStatus "DALAM_PERJALANAN")}}
                        <span class="badge badge-info"><i class="fas fa-train"></i> Dalam Perjalanan</span>
                        {{else if (eq this.journeyStatus "TIBA_LOKASI")}}
                        <span class="badge badge-success"><i class="fas fa-check-circle"></i> Tiba Lokasi</span>
                        {{else}}
                        <span class="badge badge-secondary">{{this.journeyStatus}}</span>
                        {{/if}}
                    </td>
                    <td>
                        <div class="action-btns">
                            <a href="/schedules/{{this.id}}" class="btn-icon edit" title="Lihat Detail">
                                <i class="fas fa-eye"></i>
                            </a>
                            {{#if (eq this.journeyStatus "BELUM_BERANGKAT")}}
                            {{#if (not (eq ../userRole "ADMIN"))}}
                            <button class="btn-icon" style="background: var(--success-light); color: var(--success);" onclick="openBookingModal({{this.id}}, '{{this.train.name}}', {{this.price}})" title="Pesan Tiket">
                                <i class="fas fa-ticket-alt"></i>
                            </button>
                            {{/if}}
                            {{/if}}
                            {{#if (eq ../userRole "ADMIN")}}
                            <button class="btn-icon delete" onclick="deleteSchedule({{this.id}})" title="Hapus">
                                <i class="fas fa-trash"></i>
                            </button>
                            {{/if}}
                        </div>
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
    {{else}}
    <div class="empty-state">
        <i class="fas fa-calendar-alt"></i>
        <h3>Masih Kosong</h3>
        <p>{{#if search}}Tidak ada jadwal ditemukan untuk "{{search}}"{{else}}Menunggu Admin menambahkan jadwal{{/if}}</p>
    </div>
    {{/if}}
</div>

<!-- Booking Modal -->
{{#if isLoggedIn}}
{{#if (not (eq userRole "ADMIN"))}}
<div class="modal-overlay" id="bookingModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-ticket-alt" style="color: var(--success);"></i> Pesan Tiket</h3>
            <button class="modal-close" onclick="closeModal('bookingModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form action="/bookings" method="POST">
            <input type="hidden" name="scheduleId" id="bookingScheduleId">
            <div class="modal-body">
                <p style="margin-bottom: 12px; color: var(--text-secondary);">Kereta: <strong style="color: var(--text-primary);" id="bookingTrainName"></strong></p>
                <p style="margin-bottom: 12px; color: var(--text-secondary);">Harga per kursi: <strong id="bookingPrice" style="color: var(--success);"></strong></p>
                <p style="margin-bottom: 16px; color: var(--text-muted);">Saldo Anda: <strong style="color: var(--success);">{{formatBalance balance}}</strong></p>
                
                <div class="form-group">
                    <label class="form-label">Jumlah Kursi</label>
                    <input type="number" name="seatCount" id="bookingSeatCount" class="form-control" value="1" min="1" max="10" required onchange="updateTotalPrice()">
                </div>
                
                <div style="padding: 16px; background: var(--success-light); border-radius: var(--radius-md); margin-top: 16px;">
                    <p style="margin: 0; color: var(--text-muted); font-size: 0.8125rem;">Total Harga:</p>
                    <p style="font-size: 1.5rem; font-weight: 700; color: var(--success); margin: 4px 0 0;" id="bookingTotalPrice">Rp 0</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('bookingModal')">Batal</button>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-shopping-cart"></i> Pesan Sekarang
                </button>
            </div>
        </form>
    </div>
</div>
{{/if}}
{{/if}}

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> Konfirmasi Hapus</h3>
            <button class="modal-close" onclick="closeModal('deleteModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Apakah Anda yakin ingin menghapus jadwal ini?</p>
            <p style="color: var(--text-muted); font-size: 0.8125rem; margin-top: 8px;">Tindakan ini tidak dapat dibatalkan.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('deleteModal')">Batal</button>
            <button class="btn btn-danger" id="confirmDeleteBtn"><i class="fas fa-trash"></i> Hapus</button>
        </div>
    </div>
</div>

<script>
    let scheduleToDelete = null;
    let currentPrice = 0;
    
    function deleteSchedule(id) {
        scheduleToDelete = id;
        openModal('deleteModal');
    }
    
    document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
        if (scheduleToDelete) {
            try {
                const response = await fetch('/schedules/' + scheduleToDelete, { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    window.location.href = '/schedules?message=Jadwal berhasil dihapus&messageType=success';
                } else {
                    closeModal('deleteModal');
                    showPopup('danger', result.message || 'Gagal menghapus jadwal');
                }
            } catch (error) {
                closeModal('deleteModal');
                showPopup('danger', 'Gagal menghapus jadwal');
            }
        }
    });

    function openBookingModal(scheduleId, trainName, price) {
        document.getElementById('bookingScheduleId').value = scheduleId;
        document.getElementById('bookingTrainName').textContent = trainName;
        document.getElementById('bookingPrice').textContent = 'Rp ' + price.toLocaleString('id-ID');
        document.getElementById('bookingSeatCount').value = 1;
        currentPrice = price;
        updateTotalPrice();
        openModal('bookingModal');
    }

    function updateTotalPrice() {
        const seatCount = parseInt(document.getElementById('bookingSeatCount').value) || 1;
        const total = currentPrice * seatCount;
        document.getElementById('bookingTotalPrice').textContent = 'Rp ' + total.toLocaleString('id-ID');
    }
</script>
